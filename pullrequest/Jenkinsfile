@Library('k8s-jenkins-sharedLibraries') _
pipeline{
    agent {
        kubernetes{
            cloud 'kubernetes'
            namespace 'pe-devops'
            defaultContainer 'jnlp'
            yaml getPodTemplatePR()
        }
    }
    parameters {
        string(name: 'BRANCH', defaultValue: 'master', description: 'Git project source branch', trim: true)
    }
    stages {
        stage('Get-Data') {
            steps {
                script {
                    container('jnlp') {
                        projectInfo = utils.getProjectInfo(URL_PROJECTS_YAML_RAW)
                        println projectInfo
                    }
                }
            }
        }
        stage('Fetch Code') {
            steps {
                script {
                    container('jnlp'){
                        utils.fetchCode(projectInfo.get('ssh_clone_url'), params.BRANCH)
                        appName = sh(label:"", script:"basename ${projectInfo.get('ssh_clone_url')} .git").trim()
                        baseName ="niels58/${appName}"
                        tagName = "pe-${params.BRANCH}-${BUILD_NUMBER}"
                        println """
                        APP_NAME :::: ${appName}
                        BASE_NAME :::: ${baseName}
                        TAG_NAME :::: ${tagName}
                        """
                    }
                }
            }
        }
        stage('Build') {
            steps {
                script {
                    container('maven') {
                        utils.build(projectInfo.get('cmd_build'))
                    }
                }
            }
        }
        stage('Push') {
            steps {
                script {
                    container('kaniko') {
                        utils.pushKaniko()
                    }
                }
            }
        }
    }
}